---
title: "Lab 5 assignment - Point pattern analysis"
author: "Justin Hall"
date: "2-14-2024"
output:
  html_document:
    df_print: paged
---

```{r, warning=F, error=F, message=F}
rm(list=ls())

# Load Packages
require(spatstat)
require(tidyverse)
require(terra)
require(ggplot2)
```


# Challenge 1 (3 points)

Create a simulation window on a landscape stretching from 0 to 100 units in both the x and y directions. Now simulate the distribution of an organism on this landscape using a Poisson process with a lambda value of 0.01. Plot this organism's distribution. How many organisms are there on your landscape? What is the expected number of organisms that you should find on this landscape based on your simulation parameters? Why?

```{r}
# Set the size of the landscape
landscape_size <- c(0, 100, 0, 100)

# Set the lambda value for the Poisson process
lambda_val <- 0.01

# Create the simulation window
SimWindow <- owin(xrange = landscape_size[1:2], yrange = landscape_size[3:4])

# Simulate the distribution of organisms using a Poisson process
OrganismDistribution <- rpoispp(lambda = lambda_val, win = SimWindow)

# Plot the distribution
plot(OrganismDistribution, main = "Distribution of Organisms on Landscape", xlab = "X", ylab = "Y")

print(paste("There are", OrganismDistribution$n, "organisms!"))
```

The code above shows 114 organisms, although the exclamation mark is unnecessary give the code.  Given a 100 x 100 unit simulation window (10,000 units total) and a lambda value of 0.01, around 100 organisms are expected (0.1 x 100 x 100). Consequently, the observed count of 114 surpasses the expected value by 14%. 

# Challenge 2 (3 points)

Verify that there no linear or quadratic pattern in the distribution of your organisms using fitted Poisson process models. Show the outcome of this analysis and explain your conclusion.

```{r}
#Homogeneous Poisson Process Model
model_homogeneous <- ppm(OrganismDistribution ~ 1)

#Inhomogeneous Poisson Process Model with Linear Trend
model_linear <- ppm(OrganismDistribution ~ x + y)

#Inhomogeneous Poisson Process Model with Quadratic Trend
model_quadratic <- ppm(OrganismDistribution ~ polynom(x, y, 2))

#AIC values of the three models
aic_values <- data.frame(
  Model = c('Homogeneous', 'Linear', 'Quadratic'),
  AIC = c(AIC(model_homogeneous), AIC(model_linear), AIC(model_quadratic))
)

# Print AIC values
print(aic_values)
```

The model with the lowest AIC is deemed optimal. Here, the homogeneous model holds the lowest AIC, implying that neither linear nor quadratic trends enhance it, suggesting no evidence of such patterns in the point distribution.

# Challenge 3 (14 points) (Update this code/answer)

I have simulated the distributions of 2 critters and provided their x-y coordinates. One of them is a non-territorial predator. The second is a critter that is preyed upon by the predator and exhibits a fear response to the predator's presence. Use the tools you learned in the lab to explore the distributions of these two critters. Identify which one is the predator and which is the prey, and provide code and a thorough justification supporting your conclusion.

```{r, warning=F, error=F, message=F}
#Use this code chunk to get you started.

predPreyWin = owin(xrange = c(0, 100), yrange = c(0, 100))

critter1 = read.csv('https://raw.githubusercontent.com/ValenteJJ/SpatialEcology/main/Week5/species1.csv') %>% 
  mutate(org = 'critter1')

critter2 = read.csv('https://raw.githubusercontent.com/ValenteJJ/SpatialEcology/main/Week5/species2.csv') %>% 
  mutate(org = 'critter2')
```

### ***Initially Plotting the Data***

```{r, warning=F, error=F, message=F}
# Convert critter data frames to ppp objects
ppp_critter1 <- ppp(critter1$x, critter1$y, window = predPreyWin)
ppp_critter2 <- ppp(critter2$x, critter2$y, window = predPreyWin)

# Summarize data frames
summary(ppp_critter1)
summary(ppp_critter2)

# Plotting
plot(predPreyWin, main = "Critter Distribution", col = "grey", xlim = range(c(critter1$x, critter2$x)), ylim = range(c(critter1$y, critter2$y)))
points(ppp_critter1, pch = 20, col = "blue")
points(ppp_critter2, pch = 20, col = "red")
```

Thoughts on output of code: At first glance, critter 1 appears to be the prey, and critter 2 the predator, based on their behavior. Critter 1 points cluster together, suggesting avoidance of critter 2, while critter 2 points are evenly spread, resembling non-territorial predator behavior. I'll generate density plots for further insight.

# Density Plots
```{r, warning=F, error=F, message=F}

plot(density(ppp_critter1, 1))
plot(density(ppp_critter2, 1))
```

Thoughts based on output of code: Initially, the plots show no significant differences, but the density scale is higher for critter #1 than for critter #2. This suggests critter #1 likely exhibits greater aggregation, common in prey species with avoidance behaviors. However, visual observation alone isn't enough for understanding predator-prey dynamics. Further analysis is needed for more clarity about which critter is predator and prey.

# Quadrat Counts and Chi-Square Tests
```{r, warning=F, error=F, message=F}

# Quadrat Counts & Chi-square Tests for Critter 1
q1 <- quadratcount(ppp_critter1, nx = 4, ny = 4)
plot(ppp_critter1)
plot(q1, add = TRUE)
ChiSquareTest1 <- quadrat.test(ppp_critter1, nx = 4, ny = 4, method = 'Chisq')
cat("The p-value for the critter 1 chi-square test is:", ChiSquareTest1$p.value, "\n")

# Quadrat Counts & Chi-square Tests for Critter 2
q2 <- quadratcount(ppp_critter2, nx = 4, ny = 4)
plot(ppp_critter2)
plot(q2, add = TRUE)
ChiSquareTest2 <- quadrat.test(ppp_critter2, nx = 4, ny = 4, method = 'Chisq')
cat("The p-value for the critter 2 chi-square test is:", ChiSquareTest2$p.value, "\n")
```

Thoughts on output of code:Critter #1 deviates from CSR tendencies (p < 0.05) and Critter #2 does not show substantial deviation from CSR tendencies (p > 0.05). The next statistical test that I will perform is to analyze Ripley's K and L values to measure aggregation for each critter type.

### ***Ripley's K Code***
```{r, warning=F, error=F, message=F}
# Ripley's K without correction for edge effects 
kNone1 <- Kest(ppp_critter1, correction = 'none') # Critter 1
kNone2 <- Kest(ppp_critter2, correction = 'none') # Critter 2
par(mfrow = c(1, 2))
plot(kNone1, main = "Ripley's K for Critter 1", xlab = "r", ylab = "K(r)")
plot(kNone2, main = "Ripley's K for Critter 2", xlab = "r", ylab = "K(r)")
```
Thoughts on output of code: After plotting Ripley's K without edge effect correction for each species, the insight available is no very telling. Both critters closely follow the Poisson distribution until roughly the 15-20 unit mark. I will look at the Ripley's L function (linearly plotted and scaled around zero) to see if further insight can be gained.

### ***Ripley's L Code***

```{r, warning=F, error=F, message=F}
# Ripley's L without correction for edge effects - Critter 1
lNone1 <- Lest(ppp_critter1, correction = 'none')
par(mfrow = c(1, 2))
plot(lNone1, main = "Ripley's L without Correction - Critter 1")
plot(lNone1, .-r ~ r, main = "Adjusted Ripley's L - Critter 1")

# Ripley's L without correction for edge effects - Critter 2
lNone2 <- Lest(ppp_critter2, correction = 'none')
par(mfrow = c(1, 2))
plot(lNone2, main = "Ripley's L without Correction - Critter 2")
plot(lNone2, .-r ~ r, main = "Adjusted Ripley's L - Critter 2")
```

Thoughts on output of code: Before edge correction, critter #1 consistently shows higher-than-expected aggregation up to a radius of about 12 units, sharply declining thereafter. For critter #2, Ripley's L values hover near expected levels up to approximately 15 units, then decline. Overall, critter #1 tends to aggregate, while critter #2 exhibits more random aggregation levels. The decline in Ripley's L values for both likely results from uncorrected edge effects, limiting interaction potential as the radius expands. Addressing these effects will provide a more comprehensive understanding.

### ***Ripley's L with Corrections Code***

```{r, warning=F, error=F, message=F}
# Ripley's L with isotropic correction - Critter 1
lIso1 <- Lest(ppp_critter1, correction = 'isotropic')
plot(lIso1, .-r ~ r, main = "Ripley's L with Isotropic Correction - Critter 1")

# Ripley's L with toroidal shift correction - Critter 1
lTrans1 <- Lest(ppp_critter1, correction = 'translate')
plot(lTrans1, .-r ~ r, main = "Ripley's L with Toroidal Shift - Critter 1")

# Ripley's L with isotropic correction - Critter 2
lIso2 <- Lest(ppp_critter2, correction = 'isotropic')
plot(lIso2, .-r ~ r, main = "Ripley's L with Isotropic Correction - Critter 2")

# Ripley's L with toroidal shift correction - Critter 2
lTrans2 <- Lest(ppp_critter2, correction = 'translate')
plot(lTrans2, .-r ~ r, main = "Ripley's L with Toroidal Shift - Critter 2")
```

Thoughts on output of code: Initially, we observe that Ripley's L values do not significantly decrease beyond a certain threshold, indicating the influence of edge effects on our previous findings.Notably, Ripley's L values for critter 1 differ between isotropic and toroidal shift corrections, while those for critter 2 remain consistent across correction types. Isotropic correction, adjusting point weights based on edge proximity, is deemed more appropriate in our scenario where prey species are both repelled by predators and constrained by edges. This correction better captures observed clustering near edges, which may not be accurately represented by toroidal shift. Significant aggregation in critter #1 suggests it is the prey species. Though Ripley's L values spike around 15 units for critter #2, they align more closely with a Poisson distribution compared to critter #1, indicating that critter #2 is the predator.Currently, I believe that critter #1 as prey and critter #2 as the predator, however let's proceed with further analysis.

### ***Comparison to Complete Spatial Randomness (CSR) Code***
```{r, warning=F, error=F, message=F}
set.seed(2024)

# Comparison to Complete Spatial Randomness
lCsr1 <- envelope(ppp_critter1, Lest, nsim = 99, rank = 1, correction = 'isotropic', global = FALSE)
lCsr2 <- envelope(ppp_critter2, Lest, nsim = 99, rank = 1, correction = 'isotropic', global = FALSE)

# CSR Envelope Comparison for Critter 1
plot(lCsr1, .-r ~ r, shade = c('hi', 'lo'), legend = FALSE, 
     main = "CSR Envelope Comparison for Critter 1")

# CSR Envelope Comparison for Critter 2
plot(lCsr2, .-r ~ r, shade = c('hi', 'lo'), legend = FALSE,
     main = "CSR Envelope Comparison for Critter 2")
```

Thoughts on the output of this code: After comparing to CSR, critter 1 shows stronger aggregation across 4-21 units, exceeding random distribution expectations. Conversely, critter 2 doesn't differ significantly from CSR. Thus, we confidently infer critter 1 is the prey, as its aggregation aligns with shared repulsion from predators. Let's now test how critter 1 responds to critter 2, the anticipated predators.

### ***Observing Aggregation of Critter 1 Around Critter 2: Multitype L-function Code***

```{r, warning=F, error=F, message=F}
# Prepare combined data frame
combinedCritters <- rbind(
  data.frame(x = critter1$x, y = critter1$y, species = rep("critter1", nrow(critter1))),
  data.frame(x = critter2$x, y = critter2$y, species = rep("critter2", nrow(critter2)))
)

# Ensure 'species' column is a factor
combinedCritters$species <- as.factor(combinedCritters$species)

# Convert to ppp object to be recognized as a multitype point pattern
pppCombined <- ppp(x = combinedCritters$x, y = combinedCritters$y, marks = combinedCritters$species, window = SimWindow)

# Calculate and plot Lcross
lCrossResult <- Lcross(pppCombined, i = "critter1", j = "critter2")
plot(lCrossResult, .-r ~ r, legend = TRUE, main = "Lcross for Critter1 vs Critter2")
```

Thoughts on the output of this code: This graphy indicates that #1 critters aggregate less around #2 critters than expected in a Poisson distribution. L^bord (the green dashed line) consistently remains below the expected value (0.0; blue dashed line) throughout the plot. Both "iso" and "trans" lines (black and red lines), representing isotropic and toroidal shift corrections, respectively, stay below the expected Ripley's L values, with the lowest points between 10-15 units. This directly suggests that critter 1 avoids critter 2. Further validation will occur through a simulation to determine if #1 critters are farther from #2 critters than expected under CSR.

### ***Observing Aggregation of Critter 1 Around Critter 2: Multitype L-function Code***
```{r, warning=F, error=F, message=F}
set.seed(2024)
# Calculate Lcross envelope to compare against CSR
lCrossEnv <- envelope(pppCombined, Lcross, nsim = 99, rank = 1, global = FALSE, i = "critter1", j = "critter2", simulate = expression(rlabel(pppCombined)))

# Plot the envelope
plot(lCrossEnv, .-r ~ r, legend = FALSE, main = "Lcross Envelope for Critter1 vs Critter2")
```
Thoughts on the output of this code: In our analysis, critter 1 shows notably less aggregation around critter 2 compared to 99 simulations without critter interaction. The values consistently fall below the envelope's lower boundary from around 3 units to approximately 22 units. This strongly suggests active interaction, with critter 1 being repelled by critter 2.

Final conclusion: Critter #1 is the prey species and it is actively avoiding the predator, Critter #2